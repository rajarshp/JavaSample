apiVersion: v1
kind: Namespace
metadata:
  name: cassandra-prod
---
apiVersion: v1
kind: Secret
metadata:
  name: cassandra-admin-secret
  namespace: cassandra-prod
type: Opaque
stringData:
  username: cassadmin
  # This generates a random password on deployment using OpenShift downward API.
  # If your operator does not support template substitution, generate beforehand.
  password: "{{ random 16 }}"
---
apiVersion: cassandra.datastax.com/v1beta1
kind: CassandraDatacenter
metadata:
  name: dc1
  namespace: cassandra-prod
spec:
  clusterName: cassandra-prod-cluster
  serverType: cassandra
  serverVersion: "4.1.3"
  managementApiAuth:
    insecure: false
    manual: false
    enabled: true
    secretRef:
      name: cassandra-admin-secret
  size: 3
  storageConfig:
    cassandraDataVolumeClaimSpec:
      storageClassName: gp3
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 100Gi
  resources:
    requests:
      cpu: 1000m
      memory: 2Gi
    limits:
      cpu: 2000m
      memory: 4Gi
  racks:
    - name: rack1
    - name: rack2
    - name: rack3
  config:
    cassandra-yaml:
      num_tokens: 16
      authenticator: PasswordAuthenticator
      authorizer: CassandraAuthorizer
      role_manager: CassandraRoleManager
      start_native_transport: true
      start_rpc: false
    jvm-options:
      initial_heap_size: "2G"
      max_heap_size: "4G"
      additional-jvm-opts:
        - "-Dcassandra.replace_address_first_boot=true"
  podTemplateSpec:
    metadata:
      labels:
        app: cassandra
    spec:
      containers:
        - name: cassandra
          ports:
            - containerPort: 9042
              name: cql
            - containerPort: 7000
              name: intra-node
            - containerPort: 7001
              name: tls-intra-node
---
# Service to expose CQL port
apiVersion: v1
kind: Service
metadata:
  name: cassandra-service
  namespace: cassandra-prod
  labels:
    app: cassandra
spec:
  type: ClusterIP
  ports:
    - name: cql
      port: 9042
      targetPort: 9042
  selector:
    app: cassandra
---
# Route for external access in OpenShift
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: cassandra-route
  namespace: cassandra-prod
spec:
  to:
    kind: Service
    name: cassandra-service
  port:
    targetPort: cql
  tls:
    termination: edge
